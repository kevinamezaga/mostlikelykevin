"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _objectWithoutProperties(t,e){var i={};for(var n in t)e.indexOf(n)>=0||Object.prototype.hasOwnProperty.call(t,n)&&(i[n]=t[n]);return i}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}var _createClass=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}(),WebSocket=require("universal-websocket-client"),CockpitRealTime=function(){function t(e){var i=e.host,n=e.protocol,o=void 0===n?"refresh-protocol":n;_classCallCheck(this,t),this.websocket=new WebSocket(i,o)}return _createClass(t,[{key:"on",value:function(e,i,n){t.isValidEvent(e)?(this.websocket.addEventListener("message",function(n){var o=JSON.parse(n.data);o.event.replace(t.eventPrefix,"")===e&&i(Object.assign({},o,{event:o.event}))}),this.websocket.addEventListener("error",n)):console.warn("Invalid event:",e)}}],[{key:"isValidEvent",value:function(e){if(!e)return!1;if(Object.values(t.events).includes(e))return!0;return Object.values(t.events).filter(function(t){return t.includes(".%s")}).map(function(t){return t.replace(".%s","")}).includes(e.split(".").slice(0,-1).join("."))}}]),t}();CockpitRealTime.events={CONNECT:"connect",REGIONS_SAVE_AFTER:"regions.save.after",REGIONS_REMOVE_AFTER:"regions.remove.after",COLLECTIONS_SAVE_AFTER:"collections.save.after",COLLECTIONS_SAVE_AFTER_NAME:"collections.save.after.%s",COLLECTIONS_REMOVE_AFTER:"collections.remove.after",COLLECTIONS_PREVIEW:"collections.preview"},CockpitRealTime.eventPrefix="cockpit:",module.exports=CockpitRealTime,Object.defineProperty(exports,"__esModule",{value:!0});var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_queryString=(_createClass=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}(),require("query-string")),_queryString2=_interopRequireDefault(_queryString),_isomorphicFetch=require("isomorphic-fetch"),_isomorphicFetch2=_interopRequireDefault(_isomorphicFetch),_queryString3=require("./utils/queryString"),CockpitSDK=function(){function t(e){var i=e.accessToken,n=e.defaultOptions,o=e.fetchInitOptions,s=e.host,r=e.lang,c=e.webSocket,a=e.apiEndpoints,l=void 0===a?{}:a,u=_objectWithoutProperties(e,["accessToken","defaultOptions","fetchInitOptions","host","lang","webSocket","apiEndpoints"]);_classCallCheck(this,t),this.defaultEndpoints={cockpitAssets:"/api/cockpit/assets",cockpitAuthUser:"/api/cockpit/authUser",cockpitImage:"/api/cockpit/image",cockpitListUsers:"/api/cockpit/listUsers",collectionsCollection:"/api/collections/collection/",collectionsGet:"/api/collections/get/",collectionsListCollections:"/api/collections/listCollections",collectionsRemove:"/api/collections/remove/",collectionsSave:"/api/collections/save/",regionsData:"/api/regions/data/",regionsGet:"/api/regions/get/",regionsListRegions:"/api/regions/listRegions",singletonsGet:"/api/singletons/get/",singletonsListSingletons:"/api/singletons/listSingletons",formsSubmit:"/api/forms/submit/"},this.endpoints={},this.defaultOptions={},this.fetchInitOptions={mode:"cors",cache:"default"},this.getImageOptions=function(t){return"number"==typeof t?{width:t}:t};var h=Object.keys(u);h.length&&console.error("Invalid keys:",h,"\n","Valid keys are:","accessToken, defaultOptions, fetchInitOptions, host, lang, webSocket"),this.host=s,this.lang=r,this.fetchInitOptions=Object.assign({},this.fetchInitOptions,o),this.defaultOptions=Object.assign({},this.defaultOptions,n),this.endpoints=Object.assign({},this.defaultEndpoints,l),this.accessToken=i,this.webSocket=c,this.queryParams={lang:this.lang,token:this.accessToken},c&&this.setWebsocket(c)}return _createClass(t,[{key:"fetchData",value:function(t,e,i){var n=Object.assign({},e,this.fetchInitOptions),o=""+this.host+t+"?"+_queryString2.default.stringify(this.queryParams)+"&"+_queryString2.default.stringify(i);return(0,_isomorphicFetch2.default)(o,n).then(function(t){return t.json()})}},{key:"fetchDataText",value:function(t,e,i){var n=Object.assign({},e,this.fetchInitOptions),o=""+this.host+t+"?"+_queryString2.default.stringify(this.queryParams)+"&"+_queryString2.default.stringify(i);return(0,_isomorphicFetch2.default)(o,n).then(function(t){return t.text()})}},{key:"collectionSchema",value:function(t){return this.fetchData(""+this.endpoints.collectionsCollection+t,{method:"GET"})}},{key:"collectionList",value:function(){return this.fetchData(this.endpoints.collectionsListCollections,{method:"GET"})}},{key:"collectionGet",value:function(t,e){return this.fetchData(""+this.endpoints.collectionsGet+t,{method:"POST",headers:{"Content-Type":"application/json"},body:this.stringifyOptions(e)})}},{key:"collectionSave",value:function(t,e){return this.fetchData(""+this.endpoints.collectionsSave+t,{method:"POST",headers:{"Content-Type":"application/json"},body:this.stringifyOptions({data:e})})}},{key:"collectionRemove",value:function(t,e){return this.fetchData(""+this.endpoints.collectionsRemove+t,{method:"POST",headers:{"Content-Type":"application/json"},filter:this.stringifyOptions(e)})}},{key:"stringifyOptions",value:function(t){return JSON.stringify(Object.assign({},this.defaultOptions,t))}},{key:"collection",value:function(t,e){var i=this;return{get:function(n,o){i.collectionGet(t,e).then(n).catch(o)},promise:new Promise(function(n,o){i.collectionGet(t,e).then(n).catch(o)}),schema:function(n,o){i.collectionSchema(t,e).then(n).catch(o)},watch:function(n,o){var s=function(){return i.collectionGet(t,e).then(n).catch(o)};s(),i.webSocket&&(i.webSocket.on(i.CockpitRealTime.events.COLLECTIONS_SAVE_AFTER,s,o),i.webSocket.on(i.CockpitRealTime.events.COLLECTIONS_SAVE_AFTER+"."+t,s,o))},on:function(t,e,n){var o={save:i.CockpitRealTime.events.COLLECTIONS_SAVE_AFTER,preview:i.CockpitRealTime.events.COLLECTIONS_PREVIEW};i.webSocket&&i.webSocket.on(o[t],e,n)}}}},{key:"regionGet",value:function(t,e){return this.fetchDataText(""+this.endpoints.regionsGet+t,{method:"POST",headers:{"Content-Type":"application/json"},body:this.stringifyOptions(e)})}},{key:"singletonList",value:function(){return this.fetchData(this.endpoints.singletonsListSingletons,{method:"GET"})}},{key:"singletonGet",value:function(t,e){return this.fetchData(""+this.endpoints.singletonsGet+t,{method:"POST",headers:{"Content-Type":"application/json"},body:this.stringifyOptions(e)})}},{key:"regionList",value:function(){return this.fetchData(this.endpoints.RegionsListRegions,{method:"GET"})}},{key:"regionData",value:function(t,e){return this.fetchData(""+this.endpoints.regionsData+t,{method:"POST",headers:{"Content-Type":"application/json"},body:this.stringifyOptions(e)})}},{key:"region",value:function(t,e){var i=this;return{data:function(n,o){i.regionData(t,e).then(n).catch(o)},get:function(n,o){i.regionGet(t,e).then(n).catch(o)}}}},{key:"formSubmit",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this.fetchData(""+this.endpoints.formsSubmit+t,{method:"POST",headers:{"Content-Type":"application/json"},body:this.stringifyOptions(Object.assign({form:e},i))})}},{key:"assets",value:function(t){return this.fetchData(this.endpoints.cockpitAssets,{method:"GET",headers:{"Content-Type":"application/json"}},t)}},{key:"imageGet",value:function(t,e){var i=e.width,n=e.height,o=e.quality;return this.fetchDataText(this.endpoints.cockpitImage,{method:"GET"},{src:t,w:i,h:n,q:o,d:1})}},{key:"image",value:function(t,e){if(!e||e==={}||e===[])return this.host+"/"+t;if(Array.isArray(e))return this.imageSrcSet(t,e);var i=this.getImageOptions(e),n=i.width,o=i.height,s=i.quality,r=i.pixelRatio,c=void 0===r?1:r,a=i.filters,l=_objectWithoutProperties(i,["width","height","quality","pixelRatio","filters"]),u=(0,_queryString3.stringifyObject)(a);return""+this.host+this.endpoints.cockpitImage+"?"+_queryString2.default.stringify(Object.assign({},this.queryParams,{w:n?Number(n)*c:void 0,h:o?Number(o)*c:void 0,src:t,q:s,d:1,o:1},l))+(u||"")}},{key:"imageSrcSet",value:function(t){var e=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return i?i.map(function(i){if("object"===(void 0===i?"undefined":_typeof(i))){var n=i.srcSet,o=_objectWithoutProperties(i,["srcSet"]);return e.image(t,o)+" "+(n||o.width?""+(n||o.width+"w"):"")}return e.image(t,{width:i})+" "+i+"w"}).join(", "):""}},{key:"authUser",value:function(t,e){return this.fetchData(this.endpoints.cockpitAuthUser,{method:"POST",headers:{"Content-Type":"application/json"},body:this.stringifyOptions({user:t,password:e})})}},{key:"listUsers",value:function(t){return this.fetchData(this.endpoints.cockpitListUsers,{method:"GET",headers:{"Content-Type":"application/json"}},t)}},{key:"setWebsocket",value:function(t){this.CockpitRealTime=require("./CockpitRealTime"),this.webSocket=this.CockpitRealTime({host:t})}}]),t}();CockpitSDK.events={SAVE:"save",PREVIEW:"preview"},exports.default=CockpitSDK,Object.defineProperty(exports,"__esModule",{value:!0}),exports.CockpitRealTime=void 0;var _CockpitRealTime=require("./CockpitRealTime"),_CockpitRealTime2=_interopRequireDefault(_CockpitRealTime),_CockpitSDK=require("./CockpitSDK"),_CockpitSDK2=_interopRequireDefault(_CockpitSDK);exports.default=_CockpitSDK2.default,exports.CockpitRealTime=_CockpitRealTime2.default,Object.defineProperty(exports,"__esModule",{value:!0});var stringifyObject=exports.stringifyObject=function(t){return t?Object.keys(t).reduce(function(e,i){return e+"&f["+i+"]="+t[i]},""):void 0};exports.default={};